# Genetic loci associated with somite development periodicity {#Somite-chap}

\chaptermark{Somite development periodicity}

```{r, include=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(xtable)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="latex")
# Source function enabling text wrapping around figures
devtools::source_gist("16fec9e4b02b89bf92f72355ebe313b5")
```

```{r, include=F}
# Function for colouring text
colorize <- function(x, color, col_name) {
  if (knitr::is_latex_output()) {
    # remove hash prefix
    color = stringr::str_remove(color, "#")
    sprintf("\\definecolor{%s}{HTML}{%s}\\textcolor{%s}{%s}", col_name, color, col_name, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color,
      x)
  } else x
}
```

[MOTIVATE]

## Phenotypes of interest {#somite-phenotype}

### Somite development period

**Figure \@ref(fig:ali-somite-period-lines)** shows the period data generated by pyBOAT for this study, for 100 illustrative F~2~ samples over 300 minutes. The same data can be represented by boxplots as shown in **Figure \@ref(fig:ali-somite-period-box)**. I experimented with using the F~2~ individuals' mean period and period intercept as the phenotype of interest. The two measures are highly correlated ($Pearson's~r =$ 0.84, $p$ < 2.2 x 10^-16^), so after displaying the distributions for both measures in Figure \@ref(fig:somite-phenos), I proceed to only discuss the analysis of period intercept, as it would appear to potentially be more robust to the changes in slope that can be observed in Figure \@ref(fig:ali-somite-period-lines).

(ref:ali-somite-period-lines) PyBOAT results for 100 illustrative F~2~ samples, showing the period length in minutes over the course of 300 minutes. Period tends to increase over time, meaning that as the embryo develops, each successive somite takes longer to form. Figure generated by Ali Seleit.

```{r ali-somite-period-lines, echo = F, fig.cap = '(ref:ali-somite-period-lines)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/ali_period_lines_100fish300mins.png"), auto_pdf = T)
```

(ref:ali-somite-period-box) Period measurements for 70 F~2~ individuals displayed as boxplots with each individual's median and interquartile range. Figure generated by Ali Seleit.

```{r ali-somite-period-box, echo = F, fig.cap = '(ref:ali-somite-period-box)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/ali_F2_mean_period.png"), auto_pdf = T)
```

\clearpage
### Unsegmented presomitic mesoderm area (PSM)

In the proceeding analyses, I also included a second phenotype of interest: the total area of the unsegmented tissue at the stage where 10-11 somites had been formed (**PSM area**). As the measure is simply based on the total number of pixels covered by the embryo object, I considered it to be potentially more robust than the period measurements, and therefore included it as a type of positive control for the genetic association analyses on the period phenotype. The measurements for PSM area comparing F~0~ *Cab* and *Kaga* strains are set out in **Figure \@ref(fig:ali-psm-F0)**.

(ref:ali-psm-F0) Measurements of unsegmented PSM area in pixels for the F~0~ individuals from the *Cab* strain ($N = 19$) and *Kaga* strain ($N = 10$). *Kaga* tends to have a smaller PSM than *Cab*. Figure generated by Ali Seleit.

```{r ali-psm-F0, echo = F, fig.cap = '(ref:ali-psm-F0)', out.width='60%'}
knitr::include_graphics(here::here("book/figs/somites/ali_PSM_Cab_Kaga.png"), auto_pdf = T)
```

\clearpage
### Comparisons between F~0~, F~1~ and F~2~ generations

The distributions across the F~0~, F~1~ and F~2~ generations are unexpected (**Figure \@ref(fig:somite-phenos)**). I rather expected to observe an F~2~ distribution with a similar median to the F~1~, and a variance that spanned across the extremes of the F~0~ strains. Instead, I observed that for the period phenotypes, the F~2~ generation had a mean that was slightly higher than the median of the higher-period F~0~ *Cab* strain, and many F~2~ samples exceed the period values in those F~0~ samples. Our collaborators assured me that these observations were unlikely to be caused by technical issues. A possible biological explanation of this is that there are more genetic combinations that slow down the clock rather than speed it up [@sanchezArnoldTongueEntrainment2022; @schroterSegmentNumberAxial2010]. This phenomenon could be exacerbated by the fact that the *Cab* and *Kaga* strains originate from different Japanese medaka populations (southern and northern respectively) that are understood to be at the point of speciation (see Chapter \@ref(MIKK-genomes-chap)), so this slower period may be driven by a biological incompatibility between their genomes in cases where they do not have a complete chromosome from each parent (as the F~1~ generation does). I nevertheless proceeded with the genetic analysis with a view to potentially discovering the reason for this unusual distribution.

(ref:somite-phenos) Comparisons between the F~0~, F~1~ and F~2~ generations for the three phenotypes of interest. Here, the F~0~ only includes *Cab* individuals. **A**: period intercept. **B**: period mean. **C**: unsegmented PSM area. $P$-values are derived from Kruskal-Wallis tests comparing the F~2~ individuals across microscopes. 

```{r somite-phenos, echo = F, fig.cap = '(ref:somite-phenos)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/phenotypes.png"), auto_pdf = T)
```

Another important issue to note is that the F~2~ individuals were sequenced using different microscopes of the same model (Zeiss LSM 780) but with different temperature control units and incubator boxes, denoted as 'AU' and 'DB'.^['AU' for the Aulehla Lab microscope, and 'DB' for  EMBL-Heidelberg's Developmental Biology Unit microscope.] Our collaborators noticed that there was a difference between the microscopes in their temperatures of 0.7-0.8Â°C, translating to a 4-minute difference in the F~2~ means for the period intercept measure (Kruskal-Wallis = 177.97, $p$ = 1.34 x 10^-40^), and a 3.5-minute difference in the F~2~ means for the period mean measure (Kruskal-Wallis = 141.79, $p$ = 1.08 x 10^-32^). This difference would need to be accounted for in the downstream analysis through either adjusting the phenotype prior to running the genetic association model, or by including microscope as a covariate in the model. No significant difference was found for the PSM area. 

#### Inverse-normalisation {#inverse-norm-sec}

To resolve this difference between microscopes for the period intercept data, I elected to transform it for the F~2~ generation by "inverse-normalising" the period intercept within each microscope (**Figure \@ref(fig:invnorm-intercept)**), and used this transformed phenotype for the downstream analysis. Inverse-normalisation is a rank-based normalisation approach which involves replacing the values in the phenotype vector with their rank (where ties are averaged), then converting the ranks into a normal distribution with the quantile function [@wichuraAlgorithm241Percentage1988]. The inverse-normalisation function I used for this analysis is set out in the following `R` code:

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=mystyle}
\begin{lstlisting}[language=R, caption=Inverse-normalisation function ]
invnorm = function(x) {
  res = rank(x)
  # The arbitrary 0.5 value is added to the denominator below 
  # to avoid `qnorm()` returning 'Inf' for the last-ranked value
  res = qnorm(res/(length(res)+0.5))
  return(res)
}
\end{lstlisting}

(ref:invnorm-intercept) Comparison of the period intercept phenotype data for the F~2~ generation before (**A**) and after (**B**) inverse-normalisation, with vertical lines marking the mean of each group.

```{r invnorm-intercept, echo = F, fig.cap = '(ref:invnorm-intercept)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/invnorm_intercept.png"), auto_pdf = T)
```

\clearpage
## Genetic sequencing data

Our collaborators extracted DNA from the F~0~, F~1~, and F~2~, and sequenced the F~0~ and F~1~ samples with the Illumina platform at high coverage (~26x for *Cab* and ~29x for *Kaga*), as measured by samtools [@danecekTwelveYearsSAMtools2021]. **Figure \@ref(fig:F0-coverage)** sets out the mean sequencing depth within each chromosome and across the whole genome for the *Cab* and *Kaga* F~0~ samples. Our collaborators then sequenced the F~2~ samples at low coverage (~1x), which would be sufficient to map their genotypes back to the genotypes of their parental strains (see section \@ref(somite-f2-sequencing) below for further details).

(ref:F0-coverage) Mean sequencing depth per chromosome for *Cab* and *Kaga* F~0~ strains, with genome-wide mean depth across all chromosomes shown under the subtitles.

```{r F0-coverage, echo = F, fig.cap = '(ref:F0-coverage)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/F0_coverage.png"), auto_pdf = T)
```

\clearpage
## F~0~ homozygosity and F~1~ heterozygosity

Before proceeding to map the F~2~ sequences to the genotypes of the F~0~ generation, I first investigated the levels of homozygosity in the F~0~ *Cab* and *Kaga* strains, as this would affect our ability to accurately call the F~2~ generation. That is to say, for regions where either F~0~ parent is consistently heterozygous, it would be difficult to determine the parent from which a particular F~2~ individual derived its chromosomes at that locus. I therefore aligned the high-coverage sequencing data for the F~0~ *Cab* and *Kaga* strains to the medaka *HdrR* reference (Ensembl release 104, build ASM223467v1) using BWA-MEM2, sorted the aligned .sam files, marked duplicate reads, and merged the paired reads with picard [@Picard2019toolkit], and indexed the .bam files with Samtools [@liSequenceAlignmentMap2009]. 

To call variants, I followed the GATK best practices (to the extent they were applicable) [@mckennaGenomeAnalysisToolkit2010; @depristoFrameworkVariationDiscovery2011; @vanderauweraGenomicsCloudUsing2020] with GATK's HaplotypeCaller and GenotypeGVCFs tools [@poplinScalingAccurateGenetic2018], then merged all calls into a single .vcf file with picard [@Picard2019toolkit]. Finally, I extracted the biallelic calls for *Cab* and *Kaga* with bcftools [@danecekTwelveYearsSAMtools2021], counted the number of SNPs within non-overlapping, 5-kb bins, and calculated the proportion of SNPs within each bin that were homozgyous. 

**Figure \@ref(fig:somite-f0-cab)** is a circos plot generated with circlize [@guCirclizeImplementsEnhances2014] for the *Cab* F~0~ strain used in this experiment, featuring the proportion of homozygous SNPs per 5-kb bin (green), and the total number of SNPs in each bin (yellow). As expected for a strain that has been inbred for over 10 generations, the mean homozygosity for this strain is high, with a mean proportion of homozygosity across all bins of 83%. 

(ref:somite-f0-cab) Proportion of homozygous SNPs within 5 kb bins in the *Cab* F~0~ generation genome (green), and number of SNPs in each bin (yellow).

```{r somite-f0-cab, echo = F, fig.cap = '(ref:somite-f0-cab)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/Cab.png"), auto_pdf = T)
```

\clearpage
However, the levels of homozygosity in the *Kaga* strain used in this experiment was far lower, with a mean homozygosity across all bins of only 31% (**Figure \@ref(fig:somite-f0-kaga)**). This was a surprise, as it is an established strain of [XXXX] generations, and we therefore expected the level of homozygosity to be commensurate with that observed in the *Cab* strain. An obvious exception is chr22, for which *Kaga* appears to be homozygous across its entire length.

(ref:somite-f0-kaga) Proportion of homozygous SNPs within 5 kb bins in the *Kaga* F~0~ generation genome (red), and number of SNPs in each bin (yellow).

```{r somite-f0-kaga, echo = F, fig.cap = '(ref:somite-f0-kaga)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/Kaga.png"), auto_pdf = T)
```

To determine whether the low levels of observed homozygosity in Kaga was affected by its alignments to the southern Japanese *HdrR* reference, we also aligned the F~0~ samples to the northern Japanese *HNI* reference (**Figure \@ref(fig:somite-f0-kaga-hni)**. This did not make differences to the levels of observed homozygosity in either sample, which gave us confidence that the low homozygosity observed in *Kaga* was not driven by reference bias. I understand from our collaborators that the low homozygosity of this *Kaga* individual must have resulted from the strain having been contaminated at some stage by breeding with a different inbred strain prior to when they received the individuals. 

(ref:somite-f0-kaga-hni) Proportion of homozygous SNPs within 5 kb bins in the *Kaga* F~0~ generation genome when aligned to the *HNI* reference (red), and number of SNPs in each bin (yellow).

```{r somite-f0-kaga-hni, echo = F, fig.cap = '(ref:somite-f0-kaga-hni)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/Kaga_HNI.png"), auto_pdf = T)
```

## F~1~ homozygosity {#f1-homozygosity}

I next examined the level of heterozygosity in the F~1~ generation from the *Cab*-*Kaga* cross. **Figure \@ref(fig:somite-f1)** shows the level of heterozygosity across the genome of the F~1~ hybrid in brown measured by the proportion of heterozygous SNPs within 5-kb bins (brown), and the number of SNPs in each bin (yellow). Approximately half the chromosomes show inconsistent heterozygosity, with a mean heterozygosity across all bins of 67%. This lower level of apparent heterozygosity than expected was likely caused by the low levels of homozygosity in the *Kaga* F~0~ parent. 

(ref:somite-f1) Proportion of heterozygous SNPs within 5 kb bins in the *Cab*-*Kaga* F~1~ cross (brown), and number of SNPs in each bin (yellow).

```{r somite-f1, echo = F, fig.cap = '(ref:somite-f1)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/F1.png"), auto_pdf = T)
```

For the purpose of mapping the F~2~ sample sequences to the genomes of their parental strains, I selected only biallelic SNPs that were homozygous-divergent in the F~0~ generation (i.e. homozygous reference allele in *Cab* and homozygous alternative allele in *Kaga* or vice versa) *and* heterozygous in the F~1~ generation. The number of SNPs that met these criteria per chromosome are set out in **Figure \@ref(fig:snp-counts-per-chrom)**. The strong homozygosity of *Kaga* on chr22 is likely responsible for the much greater number of loci on that chromosome that can be used for calling genoytpes in the F~2~ generation, and highlights the importance of the parental strains being highly homozygous when used in experimental crosses such as this.

(ref:snp-counts-per-chrom) Number of SNPs per chromosome that were homozygous-divergent in the F~0~ *Cab* and *Kaga* generations, and heterozygous in the F~1~ generation.

```{r snp-counts-per-chrom, echo = F, fig.cap = '(ref:snp-counts-per-chrom)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/snp_counts_per_chr_hdrr.png"), auto_pdf = T)
```

\clearpage
## F~2~ genotyping {#somite-f2-sequencing}

To maximise the efficiency of our sequencing runs, our collaborators "shallow-sequenced" the F~2~ generation with the short-read Illumina platform at a depth of ~1x. We then aligned these sequences to the *HdrR* reference with BWA-MEM2 [@vasimuddinEfficientArchitectureawareAcceleration2019], sorted the reads and marked duplicates with Picard [@Picard2019toolkit], then indexed the resulting BAM files with samtools [@danecekTwelveYearsSAMtools2021]. Genotyping these shallow sequences with the same method as used for the high-coverage sequences for the F~0~ and F~1~ generation would be inappropriate. We therefore used a different method whereby we used *bam-readcount* [@khannaBamreadcountRapidGeneration2022] to count the reads that supported either the *Cab* or the *Kaga* allele for all SNPs that met the criteria described above in section \@ref(f1-homozygosity), summed the read counts within 5 kb blocks, and calculated the frequency of reads within each bin that supported the *Kaga* allele. This generated a value for each bin between 0 and 1, where 0 signified that all reads within that bin supported the *Cab* allele, and 1 signified that all reads within that bin supported the *Kaga* allele. Bins containing no reads were imputed with a value of 0.5. 

I then used these values for all F~2~ individuals as the input to a Hidden Markov Model (HMM) with the software package *hmmlearn* [@HmmlearnHmmlearn2022], which I applied to classify each bin as one of three states, with state 0 corresponding to homozygous-*Cab*, 1 corresponding to heterozygous, and 2 corresponding to homozygous-*Kaga*. Across each chromosome of every sample, the output of the HMM was expected to produce a sequence of states. Based on previous biological knowledge that crossover events occur on average less than once per chromosome [@haenelMetaanalysisChromosomescaleCrossover2018] (see **Figure \@ref(fig:zebrafish-co-per-chrom)** for the average crossover rates per chromosome in zebrafish), I expected to observe the same state persisting for long stretches of the chromosome, only changing to another state between 0 and 3 times, and rarely more. 

```{r, include = F}
# Data from S4, haenelMetaanalysisChromosomescaleCrossover2018

## Which species have a genome length of nearly 800 Mb?
readr::read_tsv(here::here("results/somites/haenel_2018_S4.txt"),
                       comment = "#") %>% 
  dplyr::group_by(Species) %>% 
  dplyr::summarise(TOT_LEN = sum(Physical.map.length.Mb)) %>% 
  dplyr::arrange(desc(TOT_LEN))

# Cyprinus carpio (common carp) has a total genome length of 847.66 Mb (similar to 800 Mb in medaka)
df = readr::read_tsv(here::here("results/somites/haenel_2018_S4.txt"),
                       comment = "#") %>% 
  dplyr::filter(Species %in% c("Danio.renio")) %>%
  dplyr::mutate(Species = dplyr::recode(Species,
                                        "Cyprinus.carpio" = "common carp",
                                        "Homo.sapiens" = "human",
                                        "Danio.renio" = "zebrafish")) %>% 
  dplyr::mutate(Chromosome = Chromosome %>% stringr::str_remove("Chr"),
                Chromosome = Chromosome %>% 
                  as.numeric(.) %>% 
                  factor(., levels = 1:25)) %>% 
  dplyr::mutate("crossovers per chromosome" = Crossover.rate * Physical.map.length.Mb / 100) 

# Get mean crossovers per chromosome
mean_crossovers = mean(df$`crossovers per chromosome`)

```

(ref:zebrafish-co-per-chrom) Crossovers per chromosome based on data provided in @haenelMetaanalysisChromosomescaleCrossover2018, where "crossovers per chromosome" for each chromosome $c$ was calculated by $\frac{crossover~rate_{c}(cM / Mb) \times length_{c}(Mb)} {100}$. The medaka genome is shorter in length than zebrafish genome (~800 Mb compared to ~1,300 Mb), which according to the authors would suggest that medaka likely has a higher average crossover rate than what is presented in this figure.

```{r zebrafish-co-per-chrom, echo=F, fig.cap = '(ref:zebrafish-co-per-chrom)', out.width='100%'}
# Plot
df %>% 
  ggplot() +
  geom_col(aes(Chromosome, `crossovers per chromosome`, fill = Chromosome)) +
  cowplot::theme_cowplot() +
  xlab("chromosome") +
  guides(fill = "none") +
  labs(title = "Zebrafish",
       subtitle = paste("mean: ", mean_crossovers, sep = ""))
```

**Figure \@ref(fig:hmm-scat)** shows how adjusting the HMM parameters changed the called genotypes for 10 F~2~ samples on chromosome 18. Allowing the HMM to train itself for the transition probabilities and emission variances, the HMM produced an apparently noisy output (**Figure \@ref(fig:hmm-scat)A**). Fixing the transition probabilities to make it very likely for a state to transition back to itself rather than to another state.

(ref:hmm-scat) HMM states called for each bin across chr18 for 10 F~2~ samples. States 0, 1, and 2 correspond to homozygous *Cab*, heterozygous, and homozygous *Kaga*. Each point represents a 5-kb bin. Y-axis is the proportion of reads within each bin that align to the *Kaga* allele. X-axis is the bp location of the start of each bin. **A**: Standard HMM with all model parameters trained on the data. **B**. HMM with fixed transition probabilities of 0 $\rightarrow$ 0 or 1 $\rightarrow$ 1 or 2 $\rightarrow$ 2 = 0.999; 0 $\rightarrow$ 1 or 2 $\rightarrow$ 1 = 0.00066; 0 $\rightarrow$ 2 or 2 $\rightarrow$ 0 = 0.000333; 1 $\rightarrow$ 0 or 1 $\rightarrow$ 2 = 0.0005. **C**-**F** retain those transition probabilities but with different fixed emission variances of 0.01 (**C**), 0.33 (**D**), 0.8 (**E**), and 1 (**F**). 

```{r hmm-scat, echo = F, fig.cap = '(ref:hmm-scat)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/scatter_collage.png"), auto_pdf = T)
```

I used these genotype-block calls to generate the recombination karyoplot shown in **Figure \@ref(fig:karyo-wi-missing)**, with homozygous-*Cab* blocks in green, heterozoygous blocks in navy blue, and homozygous *Kaga* blocks in red. Missing calls are blank, where the vertical blank lines indicate that the region could not be called for any F~2~ individuals, likely due to an insufficient number of informative SNPs residing in those 5-kb blocks; and horizontal blank lines indicate that the sample could not be called, likely due to low sequencing coverage for that sample. 

(ref:karyo-wi-missing) Recombination blocks in 622 F~2~ samples based on the ratio of reads mapping to either the *Cab* or *Kaga* allele within 5-kb bins, with homozygous-*Cab* blocks in green, heterozoygous blocks in navy blue, and homozygous *Kaga* blocks in red. Most blocks show 0-2 crossover events, as expected, with some regions showing higher numbers of crossovers interpreted as noise. Unfilled regions are those with no state called by the HMM due to a lack of reads mapping to SNPs within those 5-kb bins.

```{r karyo-wi-missing, echo = F, fig.cap = '(ref:karyo-wi-missing)', out.height='95%', fig.align='center'}
knitr::include_graphics(here::here("book/figs/somites/karyoplot_wi_missing_cropped.png"), auto_pdf = T)
```

In the downstream analysis, I excluded the 22 samples that showed poor coverage across the genome. For the remaining samples, I "filled" the bins with missing genotypes based on the call of the previous called bin, or if unavailable (e.g. the missing bin was at the start of the chromosome), then the next called bin (**Figure \@ref(fig:karyo-no-missing)**; note that this figure retains the low-coverage samples (horizontal blank lines) that were excluded from further analysis to allow for a direct comparison with **Figure \@ref(fig:karyo-wi-missing)**). I used these filled genotype calls for the association tests described below in section **\@ref(somite-assoc-tests)**. As a rough way to estimate the accuracy of this genotyping method, we checked the genotypes called by the HMM for the reporter region on chr16 ~28.7Mb against our collaborators' manual recording of reporter gene counts based on the intensity of the *Her7*-Venus reporter's fluorescence. The confusion matrix is set out in **Table \@ref(tab:reporter-conc-tbl)**, showing that 83% of genotypes called by the HMM were consistent with the reporter fluorescence.

```{r reporter-conc-tbl, echo = F, message = F, warning = F, fig.cap = '(ref:reporter-conc-tbl)', out.width='100%'}
kableExtra::kbl(
  readr::read_csv(here::here("results/somites/hmm_reporter_conc.csv")) %>% 
    janitor::adorn_totals("row",,,, -c("HMM state", "Reporter phenotype")),
  caption = 'Confusion matrix for reporter genotype as called by the HMM, and as inferred from the fluorescence brightness.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = "striped")
```

These karyoplots show interesting recombination patterns for several chromosomes. Given the F~2~ individuals were selected for the reporter gene on chr16, as expected, there appears to be a strong strong skew towards those genotypes across the whole chromosome. On chr3, most samples are homozygous-*Cab* for the second half of the chromosome, with a consistent breakpoint around ~22 Mb. However, the final fifth of samples which show a different recombination pattern. The samples are sorted based on the order that they were phenotyped and sequenced, so this difference could have been caused by their being generated from different F~1~ individuals with distinct haplotypes. 

(ref:karyo-no-missing) Recombination blocks in 622 F~2~ samples based on the ratio of reads mapping to either the *Cab* or *Kaga* allele within 5-kb bins, with homozygous-*Cab* blocks in green, heterozoygous blocks in navy blue, and homozygous *Kaga* blocks in red. Most blocks show 0-2 crossover events, as expected, with some regions showing higher numbers of crossovers interpreted as noise. Bins with missing genotypes were "filled" based on the call of the previous called bin, or if unavailable (e.g. the missing bin was at the start of the chromosome), then the next called bin.

```{r karyo-no-missing, echo = F, fig.cap = '(ref:karyo-no-missing)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/karyoplot_no_missing_cropped.png"), auto_pdf = T)
```

**Figure \@ref(fig:prop-sites-total)** shows the proportion of 5-kb bins called as either homozygous-*Cab*, heterozygous, or homozygous-*Kaga* within each F~2~ sample (points). The ordinary expectation for the ratios would be 0.25, 0.5, and 0.25 respectively. However, we observe a skew towards homozygous-*Cab* and away from homozygous *Kaga*. This was likely caused by the hybrid incompatibility between *Cab* and *Kaga*, given the two strains were derived from populations  that are thought to be at the point of speciation (see the previous analysis in **Chapter \@ref(MIKK-genomes-chap)**, section **\@ref(introgression-sec)**). 

(ref:prop-sites-total) Proportions of 5-kb blocks called as either homozygous-*Cab*, heterozygous, or homozygous-*Kaga*.

```{r prop-sites-total, echo = F, fig.cap = '(ref:prop-sites-total)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/prop_sites_total.png"), auto_pdf = T)
```

\clearpage
## Genome-wide linkage anlaysis {#somite-assoc-tests}

Finally, I used the called recombination blocks as pseudo-SNPs in a genetic linkage analysis. To detect associations between the pseudo-SNPs and the three phenotypes of interest, I used a linear mixed model (**LMM**) as implemented in GCTA [@yangGCTAToolGenomewide2011], which follows the form set out in the Introduction in section \@ref(GWAS), equations \@ref(eq:gwaslmm) to \@ref(eq:gwaslmme). For the genetic relationship matrix (**GRM**), I additionally used the leave-one-chromosome-out implementation of GCTA's LMM, with excludes the chromosome on which the candidate SNP is located when calculating the GRM. 

As described above in **section \@ref(somite-phenotype)**, the microscope used to image the embryos (either AU or DB) differed by several degrees in heat, which likely caused differences in the measurements observed. We accordingly experimented with including microscope as a covariate, either alone or together with the genotype for the reporter locus (either homozygous or heterozygous), or excluding it altogether. In an attempt to avoid complications resulting from its inclusion, Id also tried inverse-normalising the period phenotype within each microscope group, transforming the phenotype to fit a normal distribution across both microscopes. 

To set the significance threshold, I permuted the phenotype across samples using 10 different random seeds, together with all covariates when included, and ran a separate linkage model for each permutation. I then set the lowest $p$-value from all 10 permutation as the significance threshold for the non-permuted model. I additionally applied a Bonferroni correction to our $p$-values by dividing $\alpha$ (0.05) by the number of pseudo-SNPs in the model, and set this as a secondary threshold. 

### Period intercept

**Figure \@ref(fig:somite-manhattan)** is a Manhattan plot of the genetic linkage results for the period intercept phenotype, inverse-normalised across microscopes. The regions found to be significant based on the permutations' minimum $p$-value are set out in **Table \@ref(tab:somite-sig-int-tbl)**.

(ref:somite-manhattan) Manhattan plot of the genetic linkage results for the period intercept phenotype, inverse-normalised across microscopes. Pseudo-SNPs with $p$-values lower than the permutation significance threshold are highlighted in red.

```{r somite-manhattan, echo = F, fig.cap = '(ref:somite-manhattan)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/manhattan_intercept.png"), auto_pdf = T)
```

```{r somite-sig-int-tbl, echo = F, message = F, warning = F, fig.cap = '(ref:somite-sig-int-tb)'}
xtable2kable <- function(x) {
  out <- capture.output(print(x, table.placement = NULL))[-(1:2)]
  out <- paste(out, collapse = "\n")
  structure(out, format = "latex", class = "knitr_kable")
}

kableExtra::kbl(
  readr::read_csv(here::here("results/somites/sig_regions_intercept.csv")),
  caption = 'Significant 5-kb bin ranges for period intercept below the minimum p-value from 10 permutations.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = "striped")
```

These regions contained a total of 46,872 SNPs imputed from the genotype of the F~0~ parental strains. 
I ran Ensembl's Variant Effect Predictor [@mclarenEnsemblVariantEffect2016] over these SNPs to identify those that would be most likely to have functional consequences. The full counts of SNPs falling into each category of 'consequence' are set out in **Table \@ref(tab:int-consequence-tbl)**. From this process I identified 38 genes that included a missense variant, 1 that included a missense variant and a start lost (ENSORLG00000014616), ane 1 that included a missense variant and a stop lost (ENSORLG00000015149).


```{r int-consequence-tbl, echo = F, message = F, warning = F, fig.cap = '(ref:somite-sig-int-tb)', out.width='100%'}
kableExtra::kbl(
  readr::read_csv(here::here("results/somites/intercept/vep_consequence_counts.csv")),
  caption = 'Variant Effect Predictor results for SNPs in the bins.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = "striped")
```

Our collaborators then combined these results with bulk RNA-seq that they had performed on F~0~ *Cab* and *Kaga* individuals, to determine which of these genes are expressed in the tail during embryogenesis. This allowed them to reduce to the list to 29 genes, and a gene ontology analysis of this found that the list of genes was enriched for body axis, somitogenesis, and segmentation (**Table \@ref(tab:psm-final-genes)**). For this list of genes, our collaborators are now in the process of knocking out the protein-altering *Cab* allele into *Kaga* embryos, and *vice versa*, to functionally validate these variants.

```{r psm-final-genes, echo = F, message = F, warning = F, fig.cap = '(ref:psm-final-genes)', out.width='100%'}
kableExtra::kbl(  
  readr::read_csv(here::here("results/somites/intercept/final_gene_list.csv")) %>% 
    # remove the 'Source:...' in square brackets
    dplyr::mutate(description = stringr::str_remove_all(description, "\\[.*\\]")) %>% 
    # rename columns
    dplyr::rename(Chromosome = "chromosome_name",
                  `Ensembl gene ID` = "ensembl_gene_id",
                  Description  = description),
  caption = 'Target genes for functional validation expressed in the unsegmented PSM and containing protein alterations. Table generated by Ali Seleit.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = c("striped", "scale_down")) %>% 
  kableExtra::landscape()
```

### PSM area

**Figure \@ref(fig:psm-manhattan)** is a Manhattan plot of the genetic linkage results for the PSM area phenotype. The regions found to be significant based on the permutations' minimum $p$-value are set out in **Table \@ref(tab:somite-sig-psm-tbl)**, although they exceed the Bonferroni correction threshold as well. I note that this ~6 Mb significant region on chromosome 3 does not overlap at all with the significant region discovered for the period intercept phenotype. 

(ref:psm-manhattan) Manhattan plot of the genetic linkage results for the PSM area phenotype. Pseudo-SNPs with $p$-values lower than the permutation significance threshold are highlighted in yellow.

```{r psm-manhattan, echo = F, fig.cap = '(ref:psm-manhattan)', out.width='100%'}
knitr::include_graphics(here::here("book/figs/somites/manhattan_psm_no-covariates.png"), auto_pdf = T)
```

```{r somite-sig-psm-tbl, echo = F, message = F, warning = F, fig.cap = '(ref:somite-sig-psm-tbl)', out.width='100%'}
kableExtra::kbl(
  readr::read_csv(here::here("results/somites/sig_regions_psm.csv")) %>% 
    dplyr::rename(Chromosome = CHROM),
  caption = 'Significant 5-kb bin range for PSM area below the minimum p-value from 10 permutations.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = "striped")
```

This region contained a total of 29,096 SNPs imputed from the genotype of the F~0~ parental strains. 
I ran Ensembl's Variant Effect Predictor [@mclarenEnsemblVariantEffect2016] over these SNPs to identify those that would be most likely to have functional consequences. The full counts of SNPs falling into each category of 'consequence' are set out in **Table \@ref(tab:psm-consequence-tbl)**. From this process I identified 114 genes that included a missense variant, and 1 that included a both a missense variant and a start lost (ENSORLG00000010863, a centriole, cilia and spindle-associated protein).

```{r psm-consequence-tbl, echo = F, message = F, warning = F, fig.cap = '(ref:psm-consequence-tbl)', out.width='100%'}
kableExtra::kbl(
  readr::read_csv(here::here("results/somites/psm/vep_consequence_counts.csv")),
  caption = 'Variant Effect Predictor results for SNPs in the bins.',
  booktabs = T
) %>% 
  kableExtra::kable_styling(latex_options = "striped")
```

Our collaborators then combined these results with bulk RNA-seq that they had performed on F~0~ *Cab* and *Kaga* individuals, to determine which of these genes are expressed in the unsegmented tail during embryogenesis. This allowed them to reduce to the list to 96 genes, although they were not apparently associated with a specific gene ontology. As with the period intercept phenotype, our collaborators are now in the process of knocking in the *Cab* allele into *Kaga* embryos, and *vice versa*, to functionally validate these variants.
